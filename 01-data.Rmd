\mainmatter

# 数据获取指南 {#data}

在金融数据分析领域，获取高质量的数据是开展有效分析的基础。quantmod 包作为 R 语言中处理金融时间序列数据的强大工具，提供了多种数据导入方式。本文将详细介绍如何使用 quantmod 包从网络获取金融数据以及相关参数的使用方法。

在使用 quantmod 包获取数据之前，需要先安装并加载该包。

```{R pkg, eval = FALSE}
# 安装quantmod包（如未安装）
install.packages("quantmod")
```

```{R load_pkg}
# 加载包
require(quantmod)
# 查看函数的参数信息
args(getSymbols)
```

getSymbols 函数是 quantmod 包中用于从网络获取金融数据的核心函数，其主要参数如表 \@ref{tab:param} 所示：

```{R  param, echo = FALSE}
# 创建包含参数和用途的向量
parameters <- c("Symbols", 
                "env", 
                "reload.Symbols", 
                "warnings", 
                "src", 
                "symbol.lookup", 
                "auto.assign", 
                "file.path", 
                "..."
                )
uses <- c("指定股票符号或者代码。", 
          "指定对象的创建位置。", 
          "是否在指定环境中重新载入数据，缺省设置为 FALSE。", 
          "是否输出警告信息，缺省设置为 TRUE。", 
          "指定抓取数据的网址，缺省设置为 yahoo，也可以选择 google 。", 
          "从外部查找检索股票代码的路径。", 
          "是否将函数结构自动载入到工作环境。", 
          "指定文件路径的字符串。", 
          "其它参数。")

# 创建数据框
param_df <- data.frame(
  参数 = parameters,
  用途 = uses,
  stringsAsFactors = FALSE  # 避免将字符向量转换为因子
)

# 安装并加载knitr包
# install.packages("knitr")
library(knitr)
# 使用kable()生成表格
kable(param_df, 
      col.names = c("参数", "用途"),  # 可自定义列名
      caption = "参数与用途对照表",    # 添加表格标题
      booktabs = TRUE
      ) 
```

getSymbols 函数支持多种数据源，主要包括：

* Yahoo Finance：提供全球股票、指数的日交易数据、股息数据和拆股数据
* Google Finance：提供股票价格数据和基本图表功能
* FRED (Federal Reserve Economic Data)：提供美联储发布的宏观经济数据
* OANDA：提供外汇市场的实时和历史汇率数据

通过这些数据源，我们可以获取上市公司的股票日交易数据、股息数据、拆股数据、财务报表数据、汇市数据、重金属交易数据以及美联储官网公布的一些经济数据。

下面通过具体示例展示如何使用 getSymbols 函数从不同数据源获取金融数据：

```{R datasource}
# 从Yahoo Finance获取苹果公司(AAPL)的股票数据
getSymbols("AAPL")
# 从Yahoo Finance获取中国移动(600941.SS)的股票数据
getSymbols("600941.SS")
# 从OANDA获取欧元兑美元的汇率数据
getSymbols("EUR/USD", src = "oanda")
```

在实际应用中，我们可以结合 getSymbols 函数的参数进行更灵活的数据获取：

```{R flex}
# 获取多只股票数据并保存到指定环境
myEnv <- new.env()
getSymbols(c("AAPL", "MSFT", "GOOG"), env = myEnv)
# 禁用自动赋值，将结果存储到变量中
aapl_data <- getSymbols("AAPL", auto.assign = FALSE)
# 获取数据时不显示警告信息
getSymbols("AAPL", warnings = FALSE)
# 重新加载已存在的数据
getSymbols("AAPL", reload.Symbols = TRUE)
# 使用自定义的股票代码映射
setSymbolLookup(ChinaMobile=list(name="600941.SS", src="yahoo"))
getSymbols("ChinaMobile")
```

通过以上方法，可以根据实际需求灵活获取各种金融数据，为后续的数据分析和建模工作做好准备。quantmod 包还提供了丰富的函数用于数据处理、可视化和统计分析，结合这些功能可以构建完整的金融数据分析工作流。

## 股票日交易数据获取指南

### 中国市场数据获取

在中国市场的金融数据获取中，quantmod 包的 getSymbols 函数通过特定代码格式实现数据源指定与数据抓取。中国股票市场以上海证券交易所（上交所）和深圳证券交易所（深交所）为核心，对应的数据后缀规则为：上交所股票需添加 .ss 后缀（如中国移动代码 600941.SS ），深交所股票则使用 .sz 后缀（如平安银行代码 000001.sz ）。这种标准化的代码格式不仅确保了数据接口的一致性，还能通过统一的函数调用实现跨市场数据获取，为后续的量化分析与策略开发提供规范化的数据基础。

以下是获取中国市场不同股票和指数数据的示例代码：

```{R get_chinese_mkt, eval=FALSE}
# 加载quantmod包
library(quantmod)
# 获取中国移动通讯公司股票数据（上交所代码：600941）
getSymbols("600941.SS")
# 获取特定股票数据示例（代码：600635，上交所）
getSymbols("600635.ss")
# 获取上证指数系列数据
getSymbols("000001.ss")  # 上证A股指数
getSymbols("000002.ss")  # 上证A股综合指数
getSymbols("000003.ss")  # 上证B股指数
getSymbols("000008.ss")  # 上证综合指数
# 获取沪深300指数数据
getSymbols("000300.ss")
# 获取深圳证券交易所指数数据
getSymbols("399001.sz")  # 深圳成指
# 获取特定公司股票数据（三一重工，上交所代码：600030）
getSymbols("600030.ss")
```

### 获取美国市场数据

获取美国市场的股票数据同样使用getSymbols函数，但美国股票代码通常不需要添加后缀。以下是获取美国市场知名公司股票数据的示例代码：

```{R get_usa_mkt, eval=FALSE}
# 获取苹果公司股票数据（纳斯达克代码：AAPL）
getSymbols("AAPL")
# 获取新东方教育科技集团股票数据（纳斯达克代码：EDU）
getSymbols("EDU")
# 获取比特币数据（代码为：BTC-USD）
getSymbols("BTC-USD")
```

## 交易数据的管理与重命名

在实际应用中，直接使用股票代码获取的数据对象名往往不易记忆和使用。我们可以通过 setSymbolLookup 函数建立自定义代码映射，为数据对象设置更具描述性的名称。

以下是数据重命名的示例代码：

```{R get_Ashare, eval=FALSE}
# 为上证A股综合指数设置自定义名称"A.Share.index"
setSymbolLookup(A.Share.index=list(name="000002.ss", src="yahoo"))
getSymbols("A.Share.index")

# 为上证综合指数设置自定义名称"Conglomerate.index"
setSymbolLookup(Conglomerate.index=list(name="000008.ss", src="yahoo"))
getSymbols("Conglomerate.index")
# 为沪深300指数设置自定义名称"CSI300"
setSymbolLookup(CSI300=list(name="000300.ss", src="yahoo"))
getSymbols("CSI300")
# 为深圳成指设置自定义名称"component.index"，并自动赋值
setSymbolLookup(component.index=list(name="399001.sz", src="yahoo"))
getSymbols("component.index", auto.assign = TRUE)
# 为三一重工股票设置自定义名称"SANY.HEAVY"
setSymbolLookup(SANY.HEAVY=list(name="600030.ss", src="yahoo"))
getSymbols("SANY.HEAVY")
# 查看数据前几行
head(COMPONENT.INDEX)
```

通过上述方法，我们可以更加高效地获取和管理股票交易数据，为后续的金融分析工作打下坚实基础。无论是中国市场还是美国市场的股票数据，都能通过简单的代码实现快速获取和规范命名。

## 股息与拆股数据获取指南

在量化投资分析中，上市公司的股息分配与拆股行为是影响股票价格连续性的关键因素，准确获取并处理这类数据是确保策略回测与收益计算准确性的基础。

就股息发放而言，其会导致股价产生除息缺口（如每股派息 1 美元，股价理论上应下跌 1
美元），若不进行调整，会使价格序列出现断层，导致收益率计算失真，必须根据派息信息对股价进行调整。

通过 quantmod 包中的 getDividends 函数可直接抓取上市公司历史股息记录，代码如下：

```{r getdiv, eval=FALSE}
getDividends("AAPL")
```

通过 adjustOHLC 函数可对上市公司的股价进行除息调整，调整后 Open/High/Low/Close 价格会基于股息金额向下修正，确保价格序列的连续性。以苹果公司为例：

```{r adjust}
getSymbols("AAPL", from="1990-01-01", src="yahoo")
head(AAPL)
head(AAPL.a <- adjustOHLC(AAPL))
head(AAPL.uA <- adjustOHLC(AAPL, use.Adjusted=TRUE))
```

拆股行为（如 1 拆 2、2 拆 3）会使股价按比例下降（例如 100 美元的股票 1 拆 2 后变为 50 美元），同时股东持股数量相应增加，理论上资产总价值不变。但如果缺乏拆股数据，价格序列会出现 “断崖式下跌”，直接干扰量化分析的准确性：首先，这会误导价格趋势判断， 若某股票拆股后股价从 100 美元降至 50 美元，不结合拆股信息的 K 线分析会误判为 “暴跌”，而实际股东权益并未受损；其次，拆股导致的价格断层会扭曲技术指标计算，移动平均线、波动率、MACD 等依赖历史价格的指标可能产生虚假信号（如非市场波动导致的 “金叉” 或 “死叉”）；此外，拆股数据是复权价格计算的核心基础，缺失拆股比例将无法通过前复权（将历史价格按当前股价调整）或后复权（将当前股价按历史价格调整）还原股票的真实走势。

在量化投资中，准确的价格序列是策略回测、风险评估和收益计算的基石，而 getSplits 函数正是获取上市公司拆股数据的关键工具。通过 getSplits("AAPL") 等调用方式，可直接获取标的股票的拆股历史（如拆股日期、拆股比例），这些数据与价格复权算法结合，能有效消除拆股对价格序列的干扰，确保技术分析信号的可靠性与策略回测结果的真实性。

使用 getSplits 函数可以获取上市公司的拆股数据：

```{R splits}
getSplits("AAPL")
```

股息与拆股数据是构建复权价格体系的核心要素。以股息调整为例，若回测某高股息策略时未扣除股息，会导致策略收益率被高估；而拆股数据缺失则会使技术指标（如布林带、RSI）出现断层，影响信号有效性。在实际应用中，这些数据与价格调整共同构成了量化分析的基础 —— 从计算真实的资产回报率（考虑股息再投资）到评估策略在不同市场环境下的表现，再到优化仓位管理与风险控制，每一个环节都依赖于准确的价格序列。因此，通过 getDividends、adjustOHLC 与 getSplits 函数处理数据，本质上是为量化投资构建可靠的 “数据地基”，确保策略从研发到实盘的全流程有效性。

## 期权交易数据获取取指南

期权是一种赋予持有者在约定时间内以特定价格买卖标的资产权利的金融工具，兼具风险对冲与投机功能。例如投资者买入苹果股票看跌期权，可在股价下跌时锁定损失；也可通过卖出看涨期权赚取权利金。其杠杆特性还能以小资金博取股价波动收益，同时通过组合策略（如跨式期权）对冲市场不确定性。

这些数据蕴含市场对标的资产的预期，如期权成交量、持仓量激增可能预示股价异动；隐含波动率可反映投资者恐慌或贪婪情绪，是量化策略中定价和风险评估的关键参数。此外，通过分析行权价分布，能判断市场对股价的支撑与压力位，为投资决策提供多维参考。

利用 getOptionChain 函数可以获取上市公司的期权交易数据：

```{R option}
# 获取苹果公司的期权交易数据
AAPL.OPT <- getOptionChain("AAPL")
AAPL.OPTS <- getOptionChain("AAPL", NULL)
```

与此相关的还有 options.expiry 函数和 futures.expiry  函数。options.expiry 函数可精准获取期权合约的到期日信息，对交易策略管理意义重大。通过该函数，交易者能清晰知晓期权合约的失效时间，避免因遗忘到期日导致权利金损失，同时可结合到期日分析期权时间价值衰减规律，辅助判断短期投机价值或长期对冲成本。此外，它还能帮助筛选流动性较好的合约月份，提升交易效率。futures.expiry 函数则是期货交易中的重要工具，主要用于获取期货合约的到期或交割日期。借助该函数，交易者可构建连续的期货价格序列，避免合约切换导致的数据断层，同时提前规避交割风险，尤其对不具备实物交割资格的投资者至关重要。另外，它还能为基差分析和套利策略提供支持，助力捕捉市场交易机会。

看一个关于 AAPL 的实例：

```{R get_expiry}
getSymbols("AAPL")
options.expiry(AAPL)
futures.expiry(AAPL)
print(AAPL[options.expiry(AAPL)])
```

## 汇市数据获取指南

getFX  函数可以帮助我们从[oanda](http://www.onada.com)获取汇率数据。

```{R get_fx}
getFX("USD/JPY")
head(USDJPY)
getFX("EUR/USD",from="2005-01-01")
head(EURUSD)
```

也可以使用下面的方式获取汇率数据。

```{R get_FX_2}
getSymbols("USD/EUR",src="oanda")
head(USDEUR)
getSymbols("USD/EUR",src="oanda",from="2005-01-01")
head(USDEUR)
```

## 贵重金属数据获取指南

getMetals 函数可以获取贵重金属的交易数据。

### 黄金价格获取

黄金通常以"XAU/USD"（黄金兑美元）表示：

```{R xau}
# 方法1：自动赋值（推荐）
getFX("XAU/USD", from = "2005-01-01", auto.assign = TRUE)
head(XAUUSD)  # 查看黄金数据

# 方法2：手动赋值
gold_data <- getFX("XAU/USD", from = "2005-01-01", auto.assign = FALSE)
head(gold_data)
```

### 钯金数据获取

钯金通常以"XPD/USD"表示：

```{R xpd}
getFX("XPD/USD", from = "2005-01-01", auto.assign = TRUE)
head(XPDUSD)  # 查看钯金数据
```

### 铂金数据获取

铂金通常以"XPT/USD"表示：

```{R xpt}
getFX("XPT/USD", from = "2005-01-01", auto.assign = TRUE)
head(XPTUSD)  # 查看铂金数据
```

### 批量获取多种贵金属数据

结合 lapply 批量获取多种贵金属数据：

```{R batch}
# 定义需要获取的贵金属代码
symbols <- c("XAU/USD", "XPD/USD", "XPT/USD")
names <- c("gold", "palladium", "platinum")

# 批量获取数据并命名
data_list <- lapply(symbols, function(x) {
  getFX(x, from = "2005-01-01", auto.assign = FALSE)
})
names(data_list) <- names

# 访问数据
head(data_list$gold)
head(data_list$palladium)
```

```{R vis_xau, out.width="90%"}
# 检查环境中是否存在对象
ls()  # 应显示 XAUUSD、XPDUSD、XPTUSD 等对象

# 查看数据结构
str(XAUUSD)  # 应显示时间序列数据结构

# 绘制价格走势图
plot(XAUUSD)
```

## 美联储经济数据获取指南

getSymbols.FRED 函数可以获取美联储主页上的美国经济数据。函数基本用法如下：

```{R cpi, eval= FALSE}
getSymbols('CPIAUCNS',src='FRED')
```

或者：

```{R cpi_2, eval = FALSE}
setSymbolLookup(CPIAUCNS='FRED')
getSymbols('CPIAUCNS')
```

## 数据库数据获取指南

[quantmod] (http://www.quantmod.com)也支持从本地数据库读入数据。目前，能支持的数据库类型包括：

* MySQL
* SQLite
* csv
* RData

对应的函数分别是：

* getSymbols.MySQL：从 MySQL 数据库读取数据
* getSymbols.SQLite：从 SQLite 数据库读取数据
* getSymbols.csv：从 csv 文件读取 OHLC 数据
* getSymbols.rda：读取以 .r 格式存储的数据

## 查看和移除数据

### 查看数据

```{R showsym}
getSymbols("AAPL")
showSymbols(env=.GlobalEnv)
```

### 移除数据

```{R removesym}
removeSymbols("EDU")
showSymbols(env=.GlobalEnv)
```

```{R qf, eval = FALSE}
getQuote("AAPL")
getQuote("QQQQ;SPY;^VXN",what=yahooQF(c("Bid","Ask")))
standardQuote()
yahooQF()
```

```{R attach, eval = FALSE}
attachSymbols("MSFT")
```
